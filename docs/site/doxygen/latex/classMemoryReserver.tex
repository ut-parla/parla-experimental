\hypertarget{classMemoryReserver}{}\doxysection{Memory\+Reserver Class Reference}
\label{classMemoryReserver}\index{MemoryReserver@{MemoryReserver}}


\mbox{\hyperlink{classMemoryReserver}{Memory\+Reserver}} phase of the scheduler.  




{\ttfamily \#include $<$phases.\+hpp$>$}



Inheritance diagram for Memory\+Reserver\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=181pt]{classMemoryReserver__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for Memory\+Reserver\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classMemoryReserver__coll__graph}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classMemoryReserver_a8e030d125362eb12aa0fe7a81242d71e}{Memory\+Reserver}} (\mbox{\hyperlink{classInnerScheduler}{Inner\+Scheduler}} $\ast$\mbox{\hyperlink{classSchedulerPhase_a5b1a4e7a44cc2162e50cded7bba4376f}{scheduler}}, \mbox{\hyperlink{classDeviceManager}{Device\+Manager}} $\ast$devices)
\item 
void \mbox{\hyperlink{classMemoryReserver_a2127dac8a80858f60a723345a7b7e8bc}{enqueue}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task)
\begin{DoxyCompactList}\small\item\em Enqueue a task to the phase. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classMemoryReserver_a99c935a4dd4940daa0be370e2f8d9de9}{enqueue}} (std\+::vector$<$ \mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$ $>$ \&tasks)
\begin{DoxyCompactList}\small\item\em Enqueue a vector of tasks to the phase. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classMemoryReserver_a03b6be802b5d6d19761773fa7a1df866}{run}} (\mbox{\hyperlink{classSchedulerPhase}{Scheduler\+Phase}} $\ast$next\+\_\+phase)
\begin{DoxyCompactList}\small\item\em Run the phase. Check tasks in the enqueued buffer, check phase condition, and move tasks to the next phase. \end{DoxyCompactList}\item 
size\+\_\+t \mbox{\hyperlink{classMemoryReserver_afe7011e52a6115c22c09aa4ce80b37e4}{get\+\_\+count}} ()
\begin{DoxyCompactList}\small\item\em Get the number of tasks enqueued (and waiting) in the phase. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Protected Member Functions}
\begin{DoxyCompactItemize}
\item 
bool \mbox{\hyperlink{classMemoryReserver_ac87a697034b92fb1ee9d45816cb0195c}{check\+\_\+resources}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task)
\item 
void \mbox{\hyperlink{classMemoryReserver_a687d9b805c9c57ca25c944abe186b789}{reserve\+\_\+resources}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task)
\item 
void \mbox{\hyperlink{classMemoryReserver_afefeed97cbedbebe983d4c9b770bf50f}{create\+\_\+datamove\+\_\+tasks}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task)
\end{DoxyCompactItemize}
\doxysubsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classPhaseManager}{Phase\+Manager}}$<$ \mbox{\hyperlink{resources_8hpp_aaf78cb490f07150f95154e6a8c907436a5fe7b9358c9cb1b9eaa8d5aec000def4}{Resource\+Category\+::\+Persistent}} $>$ $>$ \mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\+\_\+tasks}}
\item 
\mbox{\hyperlink{classMemoryReserverStatus}{Memory\+Reserver\+Status}} \mbox{\hyperlink{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}{status}} \{\mbox{\hyperlink{classMemoryReserver_a966fdf0157ff4674c887804c3938dc39}{name}}\}
\item 
std\+::vector$<$ \mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$ $>$ \mbox{\hyperlink{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}{reserved\+\_\+tasks\+\_\+buffer}}
\end{DoxyCompactItemize}
\doxysubsection*{Static Protected Attributes}
\begin{DoxyCompactItemize}
\item 
static const std\+::string \mbox{\hyperlink{classMemoryReserver_a966fdf0157ff4674c887804c3938dc39}{name}} \{\char`\"{}Memory Reserver\char`\"{}\}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\mbox{\hyperlink{classMemoryReserver}{Memory\+Reserver}} phase of the scheduler. 

Reserves all \textquotesingle{}persistent resources\`{}.

This phase plans task execution on the device set. Here all \textquotesingle{}persistent resources\`{} that have a lifetime greater than the task body are reserved and shared between tasks. Typically this means the memory that the task uses for both its input, output, and intermediate workspace. Memory usage is planned and reserved ahead of task execution to allow input data to be prefetched onto the devices through data movement tasks. 

Definition at line 227 of file phases.\+hpp.



\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classMemoryReserver_a8e030d125362eb12aa0fe7a81242d71e}\label{classMemoryReserver_a8e030d125362eb12aa0fe7a81242d71e}} 
\index{MemoryReserver@{MemoryReserver}!MemoryReserver@{MemoryReserver}}
\index{MemoryReserver@{MemoryReserver}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{MemoryReserver()}{MemoryReserver()}}
{\footnotesize\ttfamily Memory\+Reserver\+::\+Memory\+Reserver (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerScheduler}{Inner\+Scheduler}} $\ast$}]{scheduler,  }\item[{\mbox{\hyperlink{classDeviceManager}{Device\+Manager}} $\ast$}]{devices }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Definition at line 229 of file phases.\+hpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{230       : \mbox{\hyperlink{classSchedulerPhase_af30330d46896e1e64815407abbb06ab8}{SchedulerPhase}}(\mbox{\hyperlink{classSchedulerPhase_a5b1a4e7a44cc2162e50cded7bba4376f}{scheduler}}, \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a4cd77e2b819d63fe1c64f5f59c52360b}{devices}}) \{}
\DoxyCodeLine{231     this-\/>\mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\_tasks}} =}
\DoxyCodeLine{232         std::make\_shared<PhaseManager<ResourceCategory::Persistent>>(\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a4cd77e2b819d63fe1c64f5f59c52360b}{devices}});}
\DoxyCodeLine{233   \}}

\end{DoxyCode}


References Scheduler\+Phase\+::\+Scheduler\+Phase().



Referenced by Inner\+Scheduler\+::\+Inner\+Scheduler().

Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classMemoryReserver_a8e030d125362eb12aa0fe7a81242d71e_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classMemoryReserver_a8e030d125362eb12aa0fe7a81242d71e_icgraph}
\end{center}
\end{figure}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classMemoryReserver_ac87a697034b92fb1ee9d45816cb0195c}\label{classMemoryReserver_ac87a697034b92fb1ee9d45816cb0195c}} 
\index{MemoryReserver@{MemoryReserver}!check\_resources@{check\_resources}}
\index{check\_resources@{check\_resources}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{check\_resources()}{check\_resources()}}
{\footnotesize\ttfamily bool Memory\+Reserver\+::check\+\_\+resources (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 202 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{202                                                     \{}
\DoxyCodeLine{203   \textcolor{keywordtype}{bool} \mbox{\hyperlink{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}{status}} = \textcolor{keyword}{true};}
\DoxyCodeLine{204   \textcolor{keywordflow}{for} (\mbox{\hyperlink{classDevice}{Device}} *device : \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>assigned\_devices) \{}
\DoxyCodeLine{205     \mbox{\hyperlink{classResourcePool}{ResourcePool\_t}} \&task\_pool =}
\DoxyCodeLine{206         \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>device\_constraints[device-\/>\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}()];}
\DoxyCodeLine{207     \mbox{\hyperlink{classResourcePool}{ResourcePool\_t}} \&device\_pool = device-\/>\mbox{\hyperlink{classDevice_a23e7c65c6d833d56755aead8128763b7}{get\_reserved\_pool}}();}
\DoxyCodeLine{208 }
\DoxyCodeLine{209     \mbox{\hyperlink{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}{status}} = device\_pool.\mbox{\hyperlink{classResourcePool_a6e6f954ecbf68bc7039b1a6826664f76}{check\_greater}}<\mbox{\hyperlink{resources_8hpp_aaf78cb490f07150f95154e6a8c907436a5fe7b9358c9cb1b9eaa8d5aec000def4}{ResourceCategory::Persistent}}>(task\_pool);}
\DoxyCodeLine{210 }
\DoxyCodeLine{211     \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}{status}}) \{}
\DoxyCodeLine{212       \textcolor{keywordflow}{break};}
\DoxyCodeLine{213     \}}
\DoxyCodeLine{214   \}}
\DoxyCodeLine{215   \textcolor{keywordflow}{return} \mbox{\hyperlink{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}{status}};}
\DoxyCodeLine{216 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classMemoryReserver_afefeed97cbedbebe983d4c9b770bf50f}\label{classMemoryReserver_afefeed97cbedbebe983d4c9b770bf50f}} 
\index{MemoryReserver@{MemoryReserver}!create\_datamove\_tasks@{create\_datamove\_tasks}}
\index{create\_datamove\_tasks@{create\_datamove\_tasks}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{create\_datamove\_tasks()}{create\_datamove\_tasks()}}
{\footnotesize\ttfamily void Memory\+Reserver\+::create\+\_\+datamove\+\_\+tasks (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 229 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{229                                                           \{}
\DoxyCodeLine{230   \textcolor{comment}{// Get a list of the parrays the current task holds.}}
\DoxyCodeLine{231   \textcolor{keyword}{const} std::vector<std::vector<std::pair<parray::InnerPArray *, AccessMode>>>}
\DoxyCodeLine{232       \&parray\_list = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>parray\_list;}
\DoxyCodeLine{233   std::string task\_base\_name = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>get\_name();}
\DoxyCodeLine{234   std::vector<InnerTask *> data\_tasks;}
\DoxyCodeLine{235   data\_tasks.reserve(parray\_list.size());}
\DoxyCodeLine{236 }
\DoxyCodeLine{237   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} = 0; \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} < parray\_list.size(); ++\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}) \{}
\DoxyCodeLine{238     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} j = 0; j < parray\_list[\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}].size(); ++j) \{}
\DoxyCodeLine{239       \textcolor{comment}{// Create a data movement task for each PArray.}}
\DoxyCodeLine{240       \mbox{\hyperlink{classparray_1_1InnerPArray}{parray::InnerPArray}} *\mbox{\hyperlink{namespaceparray}{parray}} = parray\_list[\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}][j].first;}
\DoxyCodeLine{241       \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{AccessMode}} access\_mode = parray\_list[\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}][j].second;}
\DoxyCodeLine{242       \mbox{\hyperlink{classInnerDataTask}{InnerDataTask}} *datamove\_task = \textcolor{keyword}{new} \mbox{\hyperlink{classInnerDataTask}{InnerDataTask}}(}
\DoxyCodeLine{243           \textcolor{comment}{// TODO(hc): id should be updated!}}
\DoxyCodeLine{244           task\_base\_name + \textcolor{stringliteral}{"{}.dm."{}} + std::to\_string(\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}), 0, \mbox{\hyperlink{namespaceparray}{parray}}, access\_mode,}
\DoxyCodeLine{245           \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}});}
\DoxyCodeLine{246       \textcolor{keyword}{auto} \&parray\_task\_list = \mbox{\hyperlink{namespaceparray}{parray}}-\/>get\_parent\_parray()-\/>get\_task\_list\_ref();}
\DoxyCodeLine{247       \textcolor{comment}{// Find dependency intersection between compute and data movement tasks.}}
\DoxyCodeLine{248 }
\DoxyCodeLine{249       \textcolor{comment}{// TODO(hc): This is not the complete implementation.}}
\DoxyCodeLine{250       \textcolor{comment}{//           We will use a concurrent map for parray's}}
\DoxyCodeLine{251       \textcolor{comment}{//           task list as an optimization.}}
\DoxyCodeLine{252 }
\DoxyCodeLine{253       std::vector<void *> compute\_task\_dependencies = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>get\_dependencies();}
\DoxyCodeLine{254       std::vector<InnerTask *> data\_task\_dependencies;}
\DoxyCodeLine{255       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} k = 0; k < compute\_task\_dependencies.size(); ++k) \{}
\DoxyCodeLine{256         \mbox{\hyperlink{classInnerTask}{InnerTask}} *parray\_dependency =}
\DoxyCodeLine{257             \textcolor{keyword}{static\_cast<}\mbox{\hyperlink{classInnerTask}{InnerTask}} *\textcolor{keyword}{>}(compute\_task\_dependencies[k]);}
\DoxyCodeLine{258         \textcolor{comment}{// The task list in PArray is currently thread safe since}}
\DoxyCodeLine{259         \textcolor{comment}{// we do not remove tasks from the list but just keep even completed}}
\DoxyCodeLine{260         \textcolor{comment}{// task as its implementation is easier.}}
\DoxyCodeLine{261         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} t = 0; t < parray\_task\_list.size\_unsafe(); ++t) \{}
\DoxyCodeLine{262           \textcolor{keywordflow}{if} (parray\_task\_list.at\_unsafe(t)-\/>id == parray\_dependency-\/>\mbox{\hyperlink{classInnerTask_a88465fe59b98a130865d0594ca6c5e6c}{id}}) \{}
\DoxyCodeLine{263             data\_task\_dependencies.push\_back(parray\_dependency);}
\DoxyCodeLine{264           \}}
\DoxyCodeLine{265         \}}
\DoxyCodeLine{266       \}}
\DoxyCodeLine{267 }
\DoxyCodeLine{268       \textcolor{comment}{// TODO(hc): pass false to add\_dependencies() as optimization.}}
\DoxyCodeLine{269       datamove\_task-\/>\mbox{\hyperlink{classInnerTask_a1bef1f662fd0defd174abb674b961227}{add\_dependencies}}(data\_task\_dependencies, \textcolor{keyword}{true});}
\DoxyCodeLine{270       \textcolor{comment}{// Copy assigned devices to a compute task to a data movement task.}}
\DoxyCodeLine{271       \textcolor{comment}{// TODO(hc): When we support xpy, it should be devices corresponding}}
\DoxyCodeLine{272       \textcolor{comment}{//           to placements of the local partition.}}
\DoxyCodeLine{273       \textcolor{keyword}{auto} device = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>get\_assigned\_devices()[\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}];}
\DoxyCodeLine{274       datamove\_task-\/>\mbox{\hyperlink{classInnerTask_ac706288b8bd57400afe204d51793adc7}{add\_assigned\_device}}(device);}
\DoxyCodeLine{275 }
\DoxyCodeLine{276       datamove\_task-\/>\mbox{\hyperlink{classInnerTask_af5a4e559f41e09788e672a88ac6f0d14}{device\_constraints}}.emplace(}
\DoxyCodeLine{277           std::piecewise\_construct,}
\DoxyCodeLine{278           std::forward\_as\_tuple(device-\/>get\_global\_id()),}
\DoxyCodeLine{279           std::forward\_as\_tuple(0, 0, 1));}
\DoxyCodeLine{280 }
\DoxyCodeLine{281       data\_tasks.push\_back(datamove\_task);}
\DoxyCodeLine{282       \textcolor{comment}{// Add the created data movement task to a reserved task queue.}}
\DoxyCodeLine{283       this-\/>\mbox{\hyperlink{classSchedulerPhase_a5b1a4e7a44cc2162e50cded7bba4376f}{scheduler}}-\/>\mbox{\hyperlink{classInnerScheduler_a7dc689561b6acadbb9393ae92a3f3d0f}{increase\_num\_active\_tasks}}();}
\DoxyCodeLine{284       this-\/>\mbox{\hyperlink{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}{reserved\_tasks\_buffer}}.push\_back(datamove\_task);}
\DoxyCodeLine{285     \}}
\DoxyCodeLine{286   \}}
\DoxyCodeLine{287 }
\DoxyCodeLine{288   \textcolor{comment}{// Create dependencies between data move task and compute tasks.}}
\DoxyCodeLine{289   \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>add\_dependencies(data\_tasks, \textcolor{keyword}{true});}
\DoxyCodeLine{290 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classMemoryReserver_a2127dac8a80858f60a723345a7b7e8bc}\label{classMemoryReserver_a2127dac8a80858f60a723345a7b7e8bc}} 
\index{MemoryReserver@{MemoryReserver}!enqueue@{enqueue}}
\index{enqueue@{enqueue}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{enqueue()}{enqueue()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void Memory\+Reserver\+::enqueue (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [virtual]}}



Enqueue a task to the phase. 



Implements \mbox{\hyperlink{classSchedulerPhase_ab728fba49a9d47d0baa1694df9debb92}{Scheduler\+Phase}}.



Definition at line 187 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{187                                             \{}
\DoxyCodeLine{188   this-\/>\mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\_tasks}}-\/>enqueue(task);}
\DoxyCodeLine{189 \}}

\end{DoxyCode}


Referenced by Inner\+Scheduler\+::enqueue\+\_\+task().

Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classMemoryReserver_a2127dac8a80858f60a723345a7b7e8bc_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{classMemoryReserver_a99c935a4dd4940daa0be370e2f8d9de9}\label{classMemoryReserver_a99c935a4dd4940daa0be370e2f8d9de9}} 
\index{MemoryReserver@{MemoryReserver}!enqueue@{enqueue}}
\index{enqueue@{enqueue}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{enqueue()}{enqueue()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily void Memory\+Reserver\+::enqueue (\begin{DoxyParamCaption}\item[{std\+::vector$<$ \mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$ $>$ \&}]{tasks }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [virtual]}}



Enqueue a vector of tasks to the phase. 



Implements \mbox{\hyperlink{classSchedulerPhase_a61e9e3138f4eb16579cde472887e9255}{Scheduler\+Phase}}.



Definition at line 191 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{191                                                           \{}
\DoxyCodeLine{192   \textcolor{keywordflow}{for} (\mbox{\hyperlink{classInnerTask}{InnerTask}} *\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}} : \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_ad0d88a7d8f89ecf110a042149d853fb4}{tasks}}) \{}
\DoxyCodeLine{193     this-\/>\mbox{\hyperlink{classMemoryReserver_a2127dac8a80858f60a723345a7b7e8bc}{enqueue}}(\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}});}
\DoxyCodeLine{194   \}}
\DoxyCodeLine{195 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classMemoryReserver_afe7011e52a6115c22c09aa4ce80b37e4}\label{classMemoryReserver_afe7011e52a6115c22c09aa4ce80b37e4}} 
\index{MemoryReserver@{MemoryReserver}!get\_count@{get\_count}}
\index{get\_count@{get\_count}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{get\_count()}{get\_count()}}
{\footnotesize\ttfamily size\+\_\+t Memory\+Reserver\+::get\+\_\+count (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [virtual]}}



Get the number of tasks enqueued (and waiting) in the phase. 



Implements \mbox{\hyperlink{classSchedulerPhase_a0d81d78469a09647970acdc42244e79e}{Scheduler\+Phase}}.



Definition at line 197 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{197                                  \{}
\DoxyCodeLine{198   \textcolor{keywordtype}{size\_t} count = this-\/>\mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\_tasks}}-\/>size();}
\DoxyCodeLine{199   \textcolor{keywordflow}{return} count;}
\DoxyCodeLine{200 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classMemoryReserver_a687d9b805c9c57ca25c944abe186b789}\label{classMemoryReserver_a687d9b805c9c57ca25c944abe186b789}} 
\index{MemoryReserver@{MemoryReserver}!reserve\_resources@{reserve\_resources}}
\index{reserve\_resources@{reserve\_resources}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{reserve\_resources()}{reserve\_resources()}}
{\footnotesize\ttfamily void Memory\+Reserver\+::reserve\+\_\+resources (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 218 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{218                                                       \{}
\DoxyCodeLine{219   \textcolor{comment}{// TODO(wlr): Add runtime error check if resource failure}}
\DoxyCodeLine{220 }
\DoxyCodeLine{221   \textcolor{keywordflow}{for} (\mbox{\hyperlink{classDevice}{Device}} *device : \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>assigned\_devices) \{}
\DoxyCodeLine{222     \mbox{\hyperlink{classResourcePool}{ResourcePool\_t}} \&task\_pool =}
\DoxyCodeLine{223         \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>device\_constraints[device-\/>\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}()];}
\DoxyCodeLine{224     \mbox{\hyperlink{classResourcePool}{ResourcePool\_t}} \&device\_pool = device-\/>\mbox{\hyperlink{classDevice_a23e7c65c6d833d56755aead8128763b7}{get\_reserved\_pool}}();}
\DoxyCodeLine{225     device\_pool.\mbox{\hyperlink{classResourcePool_aa415c111e9279608cb3a9ca676052a3c}{decrease}}<\mbox{\hyperlink{resources_8hpp_aaf78cb490f07150f95154e6a8c907436a5fe7b9358c9cb1b9eaa8d5aec000def4}{ResourceCategory::Persistent}}>(task\_pool);}
\DoxyCodeLine{226   \}}
\DoxyCodeLine{227 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classMemoryReserver_a03b6be802b5d6d19761773fa7a1df866}\label{classMemoryReserver_a03b6be802b5d6d19761773fa7a1df866}} 
\index{MemoryReserver@{MemoryReserver}!run@{run}}
\index{run@{run}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{run()}{run()}}
{\footnotesize\ttfamily void Memory\+Reserver\+::run (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classSchedulerPhase}{Scheduler\+Phase}} $\ast$}]{next\+\_\+phase }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [virtual]}}



Run the phase. Check tasks in the enqueued buffer, check phase condition, and move tasks to the next phase. 


\begin{DoxyParams}{Parameters}
{\em next\+\_\+phase} & The next phase to move tasks to. \\
\hline
\end{DoxyParams}


Implements \mbox{\hyperlink{classSchedulerPhase_a23e561996d5bbc884e2701d6966f5670}{Scheduler\+Phase}}.



Definition at line 292 of file phases.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{292                                                    \{}
\DoxyCodeLine{293   \mbox{\hyperlink{profiling_8hpp_a4ed1a04fa9103ac0c29157e53ed53e66}{NVTX\_RANGE}}(\textcolor{stringliteral}{"{}MemoryReserver::run"{}}, \mbox{\hyperlink{profiling_8hpp_a166725049865b4af08e946c886ebe327}{NVTX\_COLOR\_LIGHT\_GREEN}})}
\DoxyCodeLine{294 }
\DoxyCodeLine{295   \textcolor{comment}{//std::cout << "{}MemoryReserver::run"{} << std::endl;}}
\DoxyCodeLine{296 }
\DoxyCodeLine{297   \mbox{\hyperlink{classRuntimeReserver}{RuntimeReserver}} *runtime\_reserver =}
\DoxyCodeLine{298       \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{classRuntimeReserver}{RuntimeReserver}} *\textcolor{keyword}{>}(next\_phase);}
\DoxyCodeLine{299 }
\DoxyCodeLine{300   \textcolor{comment}{// Only one thread can reserve memory at a time.}}
\DoxyCodeLine{301   \textcolor{comment}{// Useful for a multi-\/threaded scheduler. Not needed for a single-\/threaded.}}
\DoxyCodeLine{302   \textcolor{comment}{// std::unique\_lock<std::mutex> lock(this-\/>mtx);}}
\DoxyCodeLine{303 }
\DoxyCodeLine{304   \textcolor{comment}{// TODO:: Dummy implementation that just passes tasks through}}
\DoxyCodeLine{305   \textcolor{keywordtype}{bool} has\_task = this-\/>\mbox{\hyperlink{classMemoryReserver_afe7011e52a6115c22c09aa4ce80b37e4}{get\_count}}() > 0;}
\DoxyCodeLine{306   \textcolor{keywordflow}{while} (has\_task) \{}
\DoxyCodeLine{307     \mbox{\hyperlink{classInnerTask}{InnerTask}} *\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}} = this-\/>\mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\_tasks}}-\/>front();}
\DoxyCodeLine{308 }
\DoxyCodeLine{309     \textcolor{keywordflow}{if} (task == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{310       \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"{}MemoryReserver::run: task is nullptr"{}});}
\DoxyCodeLine{311     \}}
\DoxyCodeLine{312 }
\DoxyCodeLine{313     \textcolor{comment}{// Is there enough memory on the devices to schedule this task?}}
\DoxyCodeLine{314     \textcolor{keywordtype}{bool} can\_reserve = this-\/>\mbox{\hyperlink{classMemoryReserver_ac87a697034b92fb1ee9d45816cb0195c}{check\_resources}}(task);}
\DoxyCodeLine{315     \textcolor{keywordflow}{if} (can\_reserve) \{}
\DoxyCodeLine{316       this-\/>\mbox{\hyperlink{classMemoryReserver_a687d9b805c9c57ca25c944abe186b789}{reserve\_resources}}(task);}
\DoxyCodeLine{317       this-\/>\mbox{\hyperlink{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}{reservable\_tasks}}-\/>pop();}
\DoxyCodeLine{318       this-\/>\mbox{\hyperlink{classMemoryReserver_afefeed97cbedbebe983d4c9b770bf50f}{create\_datamove\_tasks}}(task);}
\DoxyCodeLine{319       this-\/>\mbox{\hyperlink{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}{reserved\_tasks\_buffer}}.push\_back(task);}
\DoxyCodeLine{320     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{321       \textcolor{comment}{// TODO:(wlr) we need some break condition to allow the scheduler to}}
\DoxyCodeLine{322       \textcolor{comment}{// continue if not enough resources are available Hochan, do you}}
\DoxyCodeLine{323       \textcolor{comment}{// have any ideas? One failure per scheduler loop (written here) is}}
\DoxyCodeLine{324       \textcolor{comment}{// bad. Is one failure per device per scheduler loop better?}}
\DoxyCodeLine{325       \textcolor{keywordflow}{break};}
\DoxyCodeLine{326     \}}
\DoxyCodeLine{327 }
\DoxyCodeLine{328     has\_task = this-\/>\mbox{\hyperlink{classMemoryReserver_afe7011e52a6115c22c09aa4ce80b37e4}{get\_count}}() > 0;}
\DoxyCodeLine{329   \}}
\DoxyCodeLine{330 }
\DoxyCodeLine{331   \textcolor{keywordflow}{for} (\mbox{\hyperlink{classInnerTask}{InnerTask}} *reserved\_task : this-\/>\mbox{\hyperlink{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}{reserved\_tasks\_buffer}}) \{}
\DoxyCodeLine{332     reserved\_task-\/>notify\_dependents(this-\/>\mbox{\hyperlink{classSchedulerPhase_ab309120518ecaa5abdaba9c4ece2bf5a}{enqueue\_buffer}}, \mbox{\hyperlink{namespaceTask_afa88d99eb2a58c8f078a53f1195c53a8ac0474346713027b27d364defd7bba79b}{Task::RESERVED}});}
\DoxyCodeLine{333     this-\/>\mbox{\hyperlink{classSchedulerPhase_a5b1a4e7a44cc2162e50cded7bba4376f}{scheduler}}-\/>\mbox{\hyperlink{classInnerScheduler_a6a93e103808105662ffde5d371a8f309}{enqueue\_tasks}}(this-\/>\mbox{\hyperlink{classSchedulerPhase_ab309120518ecaa5abdaba9c4ece2bf5a}{enqueue\_buffer}});}
\DoxyCodeLine{334     this-\/>\mbox{\hyperlink{classSchedulerPhase_ab309120518ecaa5abdaba9c4ece2bf5a}{enqueue\_buffer}}.clear();}
\DoxyCodeLine{335 }
\DoxyCodeLine{336     \textcolor{comment}{// TODO:(wlr) Create and possibly enqueue data movement tasks}}
\DoxyCodeLine{337 }
\DoxyCodeLine{338     \textcolor{comment}{// Possibly enqueue this task}}
\DoxyCodeLine{339     \textcolor{keywordtype}{bool} enqueue\_flag =}
\DoxyCodeLine{340         (reserved\_task-\/>num\_blocking\_dependencies.fetch\_sub(1) == 1);}
\DoxyCodeLine{341     \textcolor{keywordflow}{if} (enqueue\_flag) \{}
\DoxyCodeLine{342       reserved\_task-\/>set\_status(\mbox{\hyperlink{namespaceTask_a4397689d62196d2cfecf970fcbed6cb5a04bbf98db0e5595240e01fa33ead9ffc}{Task::RUNNABLE}});}
\DoxyCodeLine{343       runtime\_reserver-\/>\mbox{\hyperlink{classRuntimeReserver_aeab29f38dfdcc8f13fd839bf2629d1f5}{enqueue}}(reserved\_task);}
\DoxyCodeLine{344     \}}
\DoxyCodeLine{345   \}}
\DoxyCodeLine{346 }
\DoxyCodeLine{347   this-\/>reserved\_tasks\_buffer.clear();}
\DoxyCodeLine{348 \}}

\end{DoxyCode}


Referenced by Inner\+Scheduler\+::activate().

Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classMemoryReserver_a03b6be802b5d6d19761773fa7a1df866_icgraph}
\end{center}
\end{figure}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{classMemoryReserver_a966fdf0157ff4674c887804c3938dc39}\label{classMemoryReserver_a966fdf0157ff4674c887804c3938dc39}} 
\index{MemoryReserver@{MemoryReserver}!name@{name}}
\index{name@{name}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{name}{name}}
{\footnotesize\ttfamily const std\+::string Memory\+Reserver\+::name \{\char`\"{}Memory Reserver\char`\"{}\}\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}, {\ttfamily [protected]}}



Definition at line 242 of file phases.\+hpp.



Referenced by parla.\+cython.\+tasks.\+Task\+::\+\_\+\+\_\+hash\+\_\+\+\_\+(), parla.\+cython.\+tasks.\+Task\+::get\+\_\+name(), parla.\+cython.\+tasks.\+Task\+::unpack\+\_\+name(), and parla.\+cython.\+tasks.\+Task\+::update\+\_\+name().

\mbox{\Hypertarget{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}\label{classMemoryReserver_a50abec0ef02597ad2b1d74d18c5ec954}} 
\index{MemoryReserver@{MemoryReserver}!reservable\_tasks@{reservable\_tasks}}
\index{reservable\_tasks@{reservable\_tasks}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{reservable\_tasks}{reservable\_tasks}}
{\footnotesize\ttfamily std\+::shared\+\_\+ptr$<$\mbox{\hyperlink{classPhaseManager}{Phase\+Manager}}$<$\mbox{\hyperlink{resources_8hpp_aaf78cb490f07150f95154e6a8c907436a5fe7b9358c9cb1b9eaa8d5aec000def4}{Resource\+Category\+::\+Persistent}}$>$ $>$ Memory\+Reserver\+::reservable\+\_\+tasks\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 241 of file phases.\+hpp.

\mbox{\Hypertarget{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}\label{classMemoryReserver_ac879854e744f973327d1c4c76bc2a0ef}} 
\index{MemoryReserver@{MemoryReserver}!reserved\_tasks\_buffer@{reserved\_tasks\_buffer}}
\index{reserved\_tasks\_buffer@{reserved\_tasks\_buffer}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{reserved\_tasks\_buffer}{reserved\_tasks\_buffer}}
{\footnotesize\ttfamily std\+::vector$<$\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$$>$ Memory\+Reserver\+::reserved\+\_\+tasks\+\_\+buffer\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 244 of file phases.\+hpp.

\mbox{\Hypertarget{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}\label{classMemoryReserver_a664c53b781e239f130c5a6426052ae38}} 
\index{MemoryReserver@{MemoryReserver}!status@{status}}
\index{status@{status}!MemoryReserver@{MemoryReserver}}
\doxysubsubsection{\texorpdfstring{status}{status}}
{\footnotesize\ttfamily \mbox{\hyperlink{classMemoryReserverStatus}{Memory\+Reserver\+Status}} Memory\+Reserver\+::status \{\mbox{\hyperlink{classMemoryReserver_a966fdf0157ff4674c887804c3938dc39}{name}}\}\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line 243 of file phases.\+hpp.



Referenced by parla.\+cython.\+scheduler.\+Worker\+Thread\+::run().



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
src/c/backend/include/\mbox{\hyperlink{phases_8hpp}{phases.\+hpp}}\item 
src/c/backend/\mbox{\hyperlink{phases_8cpp}{phases.\+cpp}}\end{DoxyCompactItemize}
