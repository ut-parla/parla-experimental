\hypertarget{classLocalityLoadBalancingMappingPolicy}{}\doxysection{Locality\+Load\+Balancing\+Mapping\+Policy Class Reference}
\label{classLocalityLoadBalancingMappingPolicy}\index{LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}}


{\ttfamily \#include $<$policy.\+hpp$>$}



Inheritance diagram for Locality\+Load\+Balancing\+Mapping\+Policy\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=248pt]{classLocalityLoadBalancingMappingPolicy__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for Locality\+Load\+Balancing\+Mapping\+Policy\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=340pt]{classLocalityLoadBalancingMappingPolicy__coll__graph}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
bool \mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341}{calc\+\_\+score\+\_\+devplacement}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task, const std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$ \&dev\+\_\+placement\+\_\+req, const \mbox{\hyperlink{classMapper}{Mapper}} \&mapper, \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$score, const std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$ \&parray\+\_\+list) override
\begin{DoxyCompactList}\small\item\em Calculate a score of the device placement requirement. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_aeffec6001c338c09f6b971d65804965e}{calc\+\_\+score\+\_\+archplacement}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task, \mbox{\hyperlink{classArchitectureRequirement}{Architecture\+Requirement}} $\ast$arch\+\_\+placement\+\_\+req, const \mbox{\hyperlink{classMapper}{Mapper}} \&mapper, std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$ \&chosen\+\_\+dev\+\_\+req, \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$chosen\+\_\+dev\+\_\+score, const std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$ \&parray\+\_\+list, std\+::vector$<$ bool $>$ $\ast$is\+\_\+dev\+\_\+assigned=nullptr) override
\begin{DoxyCompactList}\small\item\em Calculate a score of the architecture placement requirement. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_a1f33fe9c821604def797319186daedb1}{calc\+\_\+score\+\_\+mdevplacement}} (\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$task, \mbox{\hyperlink{classMultiDeviceRequirements}{Multi\+Device\+Requirements}} $\ast$mdev\+\_\+placement\+\_\+req, const \mbox{\hyperlink{classMapper}{Mapper}} \&mapper, std\+::vector$<$ std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$$>$ $\ast$member\+\_\+device\+\_\+reqs, \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$average\+\_\+score, const std\+::vector$<$ std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$$>$ \&parray\+\_\+list) override
\begin{DoxyCompactList}\small\item\em Calculate a score of the multi-\/device placement that users passed. \end{DoxyCompactList}\item 
\mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_a1c2860ab6caf48e27a869c05d6c29c44}{Mapping\+Policy}} (\mbox{\hyperlink{classDeviceManager}{Device\+Manager}} $\ast$device\+\_\+manager, \mbox{\hyperlink{classPArrayTracker}{PArray\+Tracker}} $\ast$parray\+\_\+tracker)
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


Definition at line 107 of file policy.\+hpp.



\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classLocalityLoadBalancingMappingPolicy_aeffec6001c338c09f6b971d65804965e}\label{classLocalityLoadBalancingMappingPolicy_aeffec6001c338c09f6b971d65804965e}} 
\index{LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}!calc\_score\_archplacement@{calc\_score\_archplacement}}
\index{calc\_score\_archplacement@{calc\_score\_archplacement}!LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}}
\doxysubsubsection{\texorpdfstring{calc\_score\_archplacement()}{calc\_score\_archplacement()}}
{\footnotesize\ttfamily bool Locality\+Load\+Balancing\+Mapping\+Policy\+::calc\+\_\+score\+\_\+archplacement (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task,  }\item[{\mbox{\hyperlink{classArchitectureRequirement}{Architecture\+Requirement}} $\ast$}]{arch\+\_\+placement\+\_\+req,  }\item[{const \mbox{\hyperlink{classMapper}{Mapper}} \&}]{mapper,  }\item[{std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$ \&}]{chosen\+\_\+dev\+\_\+req,  }\item[{\mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$}]{chosen\+\_\+dev\+\_\+score,  }\item[{const std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$ \&}]{parray\+\_\+list,  }\item[{std\+::vector$<$ bool $>$ $\ast$}]{is\+\_\+dev\+\_\+assigned = {\ttfamily nullptr} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Calculate a score of the architecture placement requirement. 

This function first iterates devices of the architecture, and calculates a score for each device based on the current states of the device (e.\+g., available memory and the number of vcus). It returns a device giving the best score and its score. Note that it does not choose a device for a task, but the caller, so the task mapper, will choose one of the placement options.


\begin{DoxyParams}{Parameters}
{\em task} & Target task for task mapping. \\
\hline
{\em arch\+\_\+placement\+\_\+req} & Resource requirement of the architecture. \\
\hline
{\em mapper} & \mbox{\hyperlink{classMapper}{Mapper}} instance to get mapping information. \\
\hline
{\em chosen\+\_\+dev\+\_\+req} & A pointer of a chosen device and its resource requirement. This is a reference type since this function chooses a device and updates its pointer to the device requirement. \\
\hline
{\em chosen\+\_\+dev\+\_\+score} & A pointer of a score of the chosen device. \\
\hline
{\em parray\+\_\+list} & A list of PArray instances used by the target task \\
\hline
{\em is\+\_\+dev\+\_\+assigned} & Multi-\/device task is not allowed to be assigned to duplicated devices. This vector marks assigned devices and avoid that case. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
True if any device in the architecture is available 
\end{DoxyReturn}


Implements \mbox{\hyperlink{classMappingPolicy_a86509271105b3cf0c7478c63e3e0469d}{Mapping\+Policy}}.



Definition at line 87 of file policy.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{92                                                             \{}
\DoxyCodeLine{93   \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\_t}} best\_score\{0\};}
\DoxyCodeLine{94   std::shared\_ptr<DeviceRequirement> best\_device\_req\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{95   \textcolor{comment}{// std::cout << task-\/>get\_name() << "{}inside arch req mapping. "{} << std::endl;}}
\DoxyCodeLine{96   \textcolor{comment}{//TODO(wlr): Is this unused??}}
\DoxyCodeLine{97   uint32\_t \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}\{0\};}
\DoxyCodeLine{98   \textcolor{keywordtype}{bool} is\_arch\_available\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{99   \textcolor{comment}{// For now the architecture placement has one resource requirement}}
\DoxyCodeLine{100   \textcolor{comment}{// regardless of the devices of the architecture. In the future,}}
\DoxyCodeLine{101   \textcolor{comment}{// we will allow a separate placement for each device.}}
\DoxyCodeLine{102   \textcolor{keyword}{auto} placement\_options = arch\_placement\_req-\/>\mbox{\hyperlink{classArchitectureRequirement_af3412a9dcf9a72a470bbacdaff85b496}{GetDeviceRequirementOptions}}();}
\DoxyCodeLine{103   \textcolor{keywordtype}{int} n\_options = placement\_options.size();}
\DoxyCodeLine{104   \textcolor{keywordtype}{int} start\_idx = ++this-\/>\mbox{\hyperlink{classMappingPolicy_a3ae7076b9ebc8601ea06d3743cf12178}{rrcount}};}
\DoxyCodeLine{105 }
\DoxyCodeLine{106   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k = 0; k < n\_options; k++)\{}
\DoxyCodeLine{107     \textcolor{keywordtype}{int} idx = (start\_idx+k)\%n\_options;}
\DoxyCodeLine{108     std::shared\_ptr<DeviceRequirement> dev\_req = placement\_options[idx];}
\DoxyCodeLine{109     \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\_t}} score\{0\};}
\DoxyCodeLine{110     \mbox{\hyperlink{device_8hpp_a1a60ef2726088f66773542604d44bdd7}{DevID\_t}} dev\_global\_id = dev\_req-\/>device()-\/>get\_global\_id();}
\DoxyCodeLine{111     \textcolor{keywordflow}{if} (is\_dev\_assigned != \textcolor{keyword}{nullptr} \&\&}
\DoxyCodeLine{112             (*is\_dev\_assigned)[dev\_global\_id] == \textcolor{keyword}{true}) \{}
\DoxyCodeLine{113       \textcolor{comment}{// If this architecture placement is the member of a}}
\DoxyCodeLine{114       \textcolor{comment}{// multi-\/device task and this visiting device is already chosen}}
\DoxyCodeLine{115       \textcolor{comment}{// as one of the placements, skip it.}}
\DoxyCodeLine{116       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{117     \}}
\DoxyCodeLine{118     \textcolor{keywordtype}{bool} is\_dev\_available =}
\DoxyCodeLine{119         this-\/>\mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341}{calc\_score\_devplacement}}(task, dev\_req, mapper, \&score,}
\DoxyCodeLine{120             parray\_list);}
\DoxyCodeLine{121     \textcolor{keywordflow}{if} (!is\_dev\_available) \{}
\DoxyCodeLine{122       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{123     \}}
\DoxyCodeLine{124     is\_arch\_available = \textcolor{keyword}{true};}
\DoxyCodeLine{125     \textcolor{keywordflow}{if} (best\_score <= score) \{}
\DoxyCodeLine{126       best\_score = score;}
\DoxyCodeLine{127       best\_device\_req = dev\_req;}
\DoxyCodeLine{128     \}}
\DoxyCodeLine{129     ++\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}};}
\DoxyCodeLine{130   \}}
\DoxyCodeLine{131   assert(best\_device\_req != \textcolor{keyword}{nullptr});}
\DoxyCodeLine{132   chosen\_dev\_req = best\_device\_req;}
\DoxyCodeLine{133   *chosen\_dev\_score = best\_score;}
\DoxyCodeLine{134   \textcolor{keywordflow}{return} is\_arch\_available;}
\DoxyCodeLine{135 \}}

\end{DoxyCode}


References Mapping\+Policy\+::rrcount.

\mbox{\Hypertarget{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341}\label{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341}} 
\index{LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}!calc\_score\_devplacement@{calc\_score\_devplacement}}
\index{calc\_score\_devplacement@{calc\_score\_devplacement}!LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}}
\doxysubsubsection{\texorpdfstring{calc\_score\_devplacement()}{calc\_score\_devplacement()}}
{\footnotesize\ttfamily bool Locality\+Load\+Balancing\+Mapping\+Policy\+::calc\+\_\+score\+\_\+devplacement (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task,  }\item[{const std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$ \&}]{dev\+\_\+placement\+\_\+req,  }\item[{const \mbox{\hyperlink{classMapper}{Mapper}} \&}]{mapper,  }\item[{\mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$}]{score,  }\item[{const std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$ \&}]{parray\+\_\+list }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Calculate a score of the device placement requirement. 

This function calculates a score of a device based on the current states of the device (e.\+g., available memory and the number of vcus). It returns a device giving the best score and its score. Note that it does not choose a device for a task, but the caller, so the task mapper, will choose one of the placement options.


\begin{DoxyParams}{Parameters}
{\em task} & Target task for task mapping. \\
\hline
{\em dev\+\_\+placement\+\_\+req} & Resource requirement of the device. \\
\hline
{\em mapper} & \mbox{\hyperlink{classMapper}{Mapper}} instance to get mapping information. \\
\hline
{\em score} & A pointer of a score of the device. \\
\hline
{\em parray\+\_\+list} & A list of PArray instances used by the target task \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
True if a device is available 
\end{DoxyReturn}


Implements \mbox{\hyperlink{classMappingPolicy_a1ee22460c08db5ba7a07ab3ec673bc7b}{Mapping\+Policy}}.



Definition at line 4 of file policy.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{9                             \{}
\DoxyCodeLine{10   \textcolor{keyword}{const} \mbox{\hyperlink{classDevice}{Device}} \&device = *(dev\_placement\_req-\/>device());}
\DoxyCodeLine{11   \mbox{\hyperlink{device_8hpp_a1a60ef2726088f66773542604d44bdd7}{DevID\_t}} global\_dev\_id = device.\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}();}
\DoxyCodeLine{12   \textcolor{comment}{//std::cout << "{}[Locality-\/aware-\/ and Load-\/balancing mapping policy]\(\backslash\)n"{};}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14   \textcolor{comment}{// Check device resource availability.}}
\DoxyCodeLine{15   \textcolor{keywordflow}{if} (!device.\mbox{\hyperlink{classDevice_aca1649a233aee0f1251e1a16faf45ab3}{check\_resource\_availability}}(dev\_placement\_req.get())) \{}
\DoxyCodeLine{16     \textcolor{comment}{//std::cout << "{}Device resource failure!"{} << std::endl;}}
\DoxyCodeLine{17     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{18   \}}
\DoxyCodeLine{19 }
\DoxyCodeLine{20   \textcolor{comment}{// PArray locality.}}
\DoxyCodeLine{21   \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\_t}} local\_data\{0\}, nonlocal\_data\{0\};}
\DoxyCodeLine{22   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} = 0; \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} < parray\_list.size(); ++\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}) \{}
\DoxyCodeLine{23     \mbox{\hyperlink{classparray_1_1InnerPArray}{InnerPArray}} *\mbox{\hyperlink{namespaceparray}{parray}} = parray\_list[\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}].first;}
\DoxyCodeLine{24     \textcolor{keywordflow}{if} (\mbox{\hyperlink{classMappingPolicy_a70abf983ec3855f3a8f15db9930c5c82}{parray\_tracker\_}}-\/>\mbox{\hyperlink{classPArrayTracker_af30dd11bb2cd542a82916aab560e1840}{get\_parray\_state}}(global\_dev\_id, \mbox{\hyperlink{namespaceparray}{parray}}-\/>parent\_id)) \{}
\DoxyCodeLine{25       local\_data += \mbox{\hyperlink{namespaceparray}{parray}}-\/>get\_size();}
\DoxyCodeLine{26     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{27       nonlocal\_data += \mbox{\hyperlink{namespaceparray}{parray}}-\/>get\_size();}
\DoxyCodeLine{28     \}}
\DoxyCodeLine{29   \}}
\DoxyCodeLine{30   \mbox{\hyperlink{resources_8hpp_af7b216c3232c4a212aba859a02f42004}{Resource\_t}} device\_memory\_size = device.\mbox{\hyperlink{classDevice_a4b26ae0012a7b853adb6e98de08d88b1}{query\_resource}}(\mbox{\hyperlink{resources_8hpp_acf246a87e41f47012fc7628989d3fe95a4789f23283b3a61f858b641a1bef19a3}{Resource::Memory}});}
\DoxyCodeLine{31   local\_data /= device\_memory\_size;}
\DoxyCodeLine{32   nonlocal\_data /= device\_memory\_size;}
\DoxyCodeLine{33 }
\DoxyCodeLine{34 \textcolor{preprocessor}{\#if 0}}
\DoxyCodeLine{35   \textcolor{comment}{// TODO(hc): This metric is duplicated with data locality.}}
\DoxyCodeLine{36   \textcolor{comment}{// Check how many dependencies are mapped to the device candidate}}
\DoxyCodeLine{37   \textcolor{comment}{// being checked.}}
\DoxyCodeLine{38   \textcolor{comment}{// Note that this only considers dependencies specified in a task}}
\DoxyCodeLine{39   \textcolor{comment}{// @spawn decorator. So to speak, it considers immediate dependencies}}
\DoxyCodeLine{40   \textcolor{comment}{// and does not consider the whole dependency subtree.}}
\DoxyCodeLine{41   \mbox{\hyperlink{classProtectedVector}{TaskList}} \&\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a73544bbbe214712d0f0b214c64ebae9f}{dependencies}} = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a80c42ae6cf7c7174352631aa0d84cbe0}{task}}-\/>dependencies;}
\DoxyCodeLine{42   \textcolor{keywordtype}{size\_t} num\_dependencies\_on\_device\{0\};}
\DoxyCodeLine{43   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} = 0; \mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}} < \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a73544bbbe214712d0f0b214c64ebae9f}{dependencies}}.size\_unsafe(); ++\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}}) \{}
\DoxyCodeLine{44     \mbox{\hyperlink{classInnerTask}{InnerTask}} *\mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a82cc47fc5c9d4bba41ac5f3031d1e8fc}{dependency}} = \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a73544bbbe214712d0f0b214c64ebae9f}{dependencies}}.at\_unsafe(\mbox{\hyperlink{namespaceparla_1_1cython_1_1tasks_a17820f0441e4e8e4a8af4a5c50bae09d}{i}});}
\DoxyCodeLine{45     \textcolor{keywordflow}{for} (\mbox{\hyperlink{classDevice}{Device}} *dependency\_devices : \mbox{\hyperlink{namespaceparla_1_1cython_1_1core_a82cc47fc5c9d4bba41ac5f3031d1e8fc}{dependency}}-\/>assigned\_devices) \{}
\DoxyCodeLine{46       \textcolor{keywordflow}{if} (dependency\_devices-\/>\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}() == device.\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}()) \{}
\DoxyCodeLine{47         ++num\_dependencies\_on\_device;}
\DoxyCodeLine{48         \textcolor{keywordflow}{break};}
\DoxyCodeLine{49       \}}
\DoxyCodeLine{50     \}}
\DoxyCodeLine{51   \}}
\DoxyCodeLine{52   \textcolor{comment}{// std::cout << num\_dependencies\_on\_device << "{} of the "{} << task-\/>get\_name()}}
\DoxyCodeLine{53   \textcolor{comment}{//           << "{}s dependencies have been mapped to device "{} <<}}
\DoxyCodeLine{54   \textcolor{comment}{//           device.get\_name()}}
\DoxyCodeLine{55   \textcolor{comment}{//           << "{}\(\backslash\)n"{};}}
\DoxyCodeLine{56 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{57 }
\DoxyCodeLine{58   \textcolor{comment}{// TODO(hc): memory load; but let me postpone this implementation because}}
\DoxyCodeLine{59   \textcolor{comment}{//           it may require nested for loops.}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61   \textcolor{comment}{// Calculate device load balancing.}}
\DoxyCodeLine{62   \textcolor{keywordtype}{size\_t} total\_num\_mapped\_tasks = mapper.\mbox{\hyperlink{classMapper_a3e63ef68173ab3c9ce42e0e077e681cf}{atomic\_load\_total\_num\_mapped\_tasks}}();}
\DoxyCodeLine{63   \textcolor{keywordtype}{size\_t} num\_tasks\_to\_device =}
\DoxyCodeLine{64       mapper.\mbox{\hyperlink{classMapper_a4fda5c4fbe57ee41131f07d039d45d37}{atomic\_load\_dev\_num\_mapped\_tasks\_device}}(device.\mbox{\hyperlink{classDevice_a7a4beec758f8c827ffce31562ee9ebdb}{get\_global\_id}}());}
\DoxyCodeLine{65   \textcolor{keywordtype}{double} normalizd\_device\_load\{0\};}
\DoxyCodeLine{66   \textcolor{keywordflow}{if} (total\_num\_mapped\_tasks != 0) \{}
\DoxyCodeLine{67     normalizd\_device\_load =}
\DoxyCodeLine{68         num\_tasks\_to\_device / double(total\_num\_mapped\_tasks);}
\DoxyCodeLine{69   \}}
\DoxyCodeLine{70 }
\DoxyCodeLine{71   \textcolor{comment}{// Avoid negative score and make this focus on load balancing if data}}
\DoxyCodeLine{72   \textcolor{comment}{// is not used.}}
\DoxyCodeLine{73   *score = 50;}
\DoxyCodeLine{74   *score += (30.0 * local\_data -\/ 30.0 * nonlocal\_data -\/ 10 * normalizd\_device\_load);}
\DoxyCodeLine{75 }
\DoxyCodeLine{76   \textcolor{comment}{// std::cout << "{}Device "{} << device.get\_name() << "{}'s score: "{} << *score <<}}
\DoxyCodeLine{77   \textcolor{comment}{//   "{} for task "{}<< task-\/>get\_name() << "{} local data: "{} << local\_data <<}}
\DoxyCodeLine{78   \textcolor{comment}{//   "{} non local data:"{} << nonlocal\_data << "{} normalized device load:"{} <<}}
\DoxyCodeLine{79   \textcolor{comment}{//   normalizd\_device\_load << "{}\(\backslash\)n"{};}}
\DoxyCodeLine{80   \textcolor{comment}{// std::cout << "{}\(\backslash\)t[Device Requirement in device Requirement]\(\backslash\)n"{}}}
\DoxyCodeLine{81   \textcolor{comment}{//           << "{}\(\backslash\)t\(\backslash\)t"{} << dev\_placement\_req-\/>device()-\/>get\_name() << "{} -\/> "{}}}
\DoxyCodeLine{82   \textcolor{comment}{//           << dev\_placement\_req-\/>res\_req().get(Resource::Memory) << "{}B, VCU"{}}}
\DoxyCodeLine{83   \textcolor{comment}{//           << dev\_placement\_req-\/>res\_req().get(Resource::VCU) << "{}\(\backslash\)n"{};}}
\DoxyCodeLine{84   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{85 \}}

\end{DoxyCode}


References Mapper\+::atomic\+\_\+load\+\_\+total\+\_\+num\+\_\+mapped\+\_\+tasks().

Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{classLocalityLoadBalancingMappingPolicy_a1f33fe9c821604def797319186daedb1}\label{classLocalityLoadBalancingMappingPolicy_a1f33fe9c821604def797319186daedb1}} 
\index{LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}!calc\_score\_mdevplacement@{calc\_score\_mdevplacement}}
\index{calc\_score\_mdevplacement@{calc\_score\_mdevplacement}!LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}}
\doxysubsubsection{\texorpdfstring{calc\_score\_mdevplacement()}{calc\_score\_mdevplacement()}}
{\footnotesize\ttfamily bool Locality\+Load\+Balancing\+Mapping\+Policy\+::calc\+\_\+score\+\_\+mdevplacement (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classInnerTask}{Inner\+Task}} $\ast$}]{task,  }\item[{\mbox{\hyperlink{classMultiDeviceRequirements}{Multi\+Device\+Requirements}} $\ast$}]{mdev\+\_\+placement\+\_\+req,  }\item[{const \mbox{\hyperlink{classMapper}{Mapper}} \&}]{mapper,  }\item[{std\+::vector$<$ std\+::shared\+\_\+ptr$<$ \mbox{\hyperlink{classDeviceRequirement}{Device\+Requirement}} $>$$>$ $\ast$}]{member\+\_\+device\+\_\+reqs,  }\item[{\mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\+\_\+t}} $\ast$}]{average\+\_\+score,  }\item[{const std\+::vector$<$ std\+::vector$<$ std\+::pair$<$ \mbox{\hyperlink{classparray_1_1InnerPArray}{parray\+::\+Inner\+PArray}} $\ast$, \mbox{\hyperlink{runtime_8hpp_ab22d35ed086a478dd91e93ac78037f40}{Access\+Mode}} $>$$>$$>$ \&}]{parray\+\_\+list }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Calculate a score of the multi-\/device placement that users passed. 

The placement requirement could contain multiple device or/and architecture requirements. This function calculates a score for each placement requirement by recursively calling a device or an architecture score calculation function and averages those scores. This average is used as a score of the multi-\/device placement and the caller, so the task mapper, will choose one of the placement options that give the best score.


\begin{DoxyParams}{Parameters}
{\em task} & Target task for task mapping. \\
\hline
{\em mdev\+\_\+placement\+\_\+req} & Resource requirement of the multiple devices. \\
\hline
{\em mapper} & \mbox{\hyperlink{classMapper}{Mapper}} instance to get mapping information. \\
\hline
{\em member\+\_\+device\+\_\+reqs} & A vector of the resource requirement of the member device. \\
\hline
{\em chosen\+\_\+dev\+\_\+score} & A pointer of a score of the multiple devices. \\
\hline
{\em parray\+\_\+list} & A list of PArray instances used by the target task \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
True if all devices in the multi-\/device placement are available. 
\end{DoxyReturn}


Implements \mbox{\hyperlink{classMappingPolicy_a5cd045c4167ac1c7e542fec83eaae55d}{Mapping\+Policy}}.



Definition at line 137 of file policy.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{144                         \{}
\DoxyCodeLine{145   *average\_score = 0;}
\DoxyCodeLine{146   \textcolor{keyword}{const} std::vector<std::shared\_ptr<SinglePlacementRequirementBase>>}
\DoxyCodeLine{147       \&placement\_reqs\_vec = mdev\_placement\_req-\/>\mbox{\hyperlink{classMultiDeviceRequirements_ac5e4ee0e9a54f8e45318f9059aea9540}{get\_placement\_reqs\_ref}}();}
\DoxyCodeLine{148   member\_device\_reqs-\/>resize(placement\_reqs\_vec.size());}
\DoxyCodeLine{149   \textcolor{comment}{// Task mapper does not allow to map a multi-\/device task to the same device}}
\DoxyCodeLine{150   \textcolor{comment}{// multiple times. This vector marks an assigned device and filter it}}
\DoxyCodeLine{151   \textcolor{comment}{// out at the next device decision.}}
\DoxyCodeLine{152   std::vector<bool> is\_dev\_assigned(}
\DoxyCodeLine{153       this-\/>\mbox{\hyperlink{classMappingPolicy_a3943af0460a1a7053151449167da0d26}{device\_manager\_}}-\/>\mbox{\hyperlink{classDeviceManager_ad3dba27b05b965eba693d8fecd89f9c7}{get\_num\_devices}}<\mbox{\hyperlink{device_8hpp_ad258d4c51629346fceac4679b3209ad9ab1c94ca2fbc3e78fc30069c8d0f01680}{DeviceType::All}}>(), \textcolor{keyword}{false});}
\DoxyCodeLine{154   \textcolor{comment}{// Iterate requirements of the devices specified in multi-\/device placement.}}
\DoxyCodeLine{155   \textcolor{comment}{// All of the member devices should be available.}}
\DoxyCodeLine{156   \textcolor{keywordflow}{for} (\mbox{\hyperlink{device_8hpp_a1a60ef2726088f66773542604d44bdd7}{DevID\_t}} did = 0; did < placement\_reqs\_vec.size(); ++did) \{}
\DoxyCodeLine{157     std::shared\_ptr<SinglePlacementRequirementBase> placement\_req =}
\DoxyCodeLine{158         placement\_reqs\_vec[did];}
\DoxyCodeLine{159     std::shared\_ptr<DeviceRequirement> dev\_req\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{160     \mbox{\hyperlink{policy_8hpp_acc133555210d07ca50d128e110e9e7a9}{Score\_t}} score\{0\};}
\DoxyCodeLine{161     \textcolor{keywordtype}{bool} is\_member\_device\_available\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{162     \textcolor{keywordflow}{if} (placement\_req-\/>is\_dev\_req()) \{}
\DoxyCodeLine{163       dev\_req = std::dynamic\_pointer\_cast<DeviceRequirement>(placement\_req);}
\DoxyCodeLine{164       \mbox{\hyperlink{device_8hpp_a1a60ef2726088f66773542604d44bdd7}{DevID\_t}} dev\_global\_id = dev\_req-\/>device()-\/>get\_global\_id();}
\DoxyCodeLine{165       \textcolor{keywordflow}{if} (!is\_dev\_assigned[dev\_global\_id]) \{}
\DoxyCodeLine{166         is\_member\_device\_available =}
\DoxyCodeLine{167             this-\/>\mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_ad4dd7032ab349a74f3ab4498c867a341}{calc\_score\_devplacement}}(task, dev\_req, mapper, \&score,}
\DoxyCodeLine{168                 parray\_list[did]);}
\DoxyCodeLine{169         \textcolor{keywordflow}{if} (is\_member\_device\_available) \{}
\DoxyCodeLine{170           is\_dev\_assigned[dev\_global\_id] = \textcolor{keyword}{true};}
\DoxyCodeLine{171         \}}
\DoxyCodeLine{172       \}}
\DoxyCodeLine{173     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (placement\_req-\/>is\_arch\_req()) \{}
\DoxyCodeLine{174       \mbox{\hyperlink{classArchitectureRequirement}{ArchitectureRequirement}} *arch\_req =}
\DoxyCodeLine{175           \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{classArchitectureRequirement}{ArchitectureRequirement}} *\textcolor{keyword}{>}(placement\_req.get());}
\DoxyCodeLine{176       is\_member\_device\_available = this-\/>\mbox{\hyperlink{classLocalityLoadBalancingMappingPolicy_aeffec6001c338c09f6b971d65804965e}{calc\_score\_archplacement}}(}
\DoxyCodeLine{177           task, arch\_req, mapper, dev\_req, \&score, parray\_list[did],}
\DoxyCodeLine{178           \&is\_dev\_assigned);}
\DoxyCodeLine{179       \textcolor{keywordflow}{if} (is\_member\_device\_available) \{}
\DoxyCodeLine{180         \mbox{\hyperlink{device_8hpp_a1a60ef2726088f66773542604d44bdd7}{DevID\_t}} dev\_global\_id = dev\_req-\/>device()-\/>get\_global\_id();}
\DoxyCodeLine{181         is\_dev\_assigned[dev\_global\_id] = \textcolor{keyword}{true};}
\DoxyCodeLine{182       \}}
\DoxyCodeLine{183     \}}
\DoxyCodeLine{184     assert(dev\_req != \textcolor{keyword}{nullptr});}
\DoxyCodeLine{185     (*member\_device\_reqs)[did] = dev\_req;}
\DoxyCodeLine{186     *average\_score += score;}
\DoxyCodeLine{187     \textcolor{keywordflow}{if} (!is\_member\_device\_available) \{}
\DoxyCodeLine{188       \textcolor{comment}{// If any of the device candidates is not available,}}
\DoxyCodeLine{189       \textcolor{comment}{// return false and exclude this option from task mapping.}}
\DoxyCodeLine{190       \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{191     \}}
\DoxyCodeLine{192   \}}
\DoxyCodeLine{193   *average\_score /= placement\_reqs\_vec.size();}
\DoxyCodeLine{194   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{195 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classLocalityLoadBalancingMappingPolicy_a1c2860ab6caf48e27a869c05d6c29c44}\label{classLocalityLoadBalancingMappingPolicy_a1c2860ab6caf48e27a869c05d6c29c44}} 
\index{LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}!MappingPolicy@{MappingPolicy}}
\index{MappingPolicy@{MappingPolicy}!LocalityLoadBalancingMappingPolicy@{LocalityLoadBalancingMappingPolicy}}
\doxysubsubsection{\texorpdfstring{MappingPolicy()}{MappingPolicy()}}
{\footnotesize\ttfamily Mapping\+Policy\+::\+Mapping\+Policy\hspace{0.3cm}{\ttfamily [inline]}}



Definition at line 20 of file policy.\+hpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{21       : \mbox{\hyperlink{classMappingPolicy_a3943af0460a1a7053151449167da0d26}{device\_manager\_}}(device\_manager), \mbox{\hyperlink{classMappingPolicy_a70abf983ec3855f3a8f15db9930c5c82}{parray\_tracker\_}}(parray\_tracker) \{\}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
src/c/backend/include/\mbox{\hyperlink{policy_8hpp}{policy.\+hpp}}\item 
src/c/backend/\mbox{\hyperlink{policy_8cpp}{policy.\+cpp}}\end{DoxyCompactItemize}
